var t=Object.defineProperty,e=(e,i,s)=>(((e,i,s)=>{i in e?t(e,i,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[i]=s})(e,"symbol"!=typeof i?i+"":i,s),s);import{al as i,b as s,i as r,f as a,aq as n,ar as o,E as l,a7 as h,as as d,ab as u,q as c,A as g,ak as f}from"./index-76e412f7.js";import{P as p}from"./PageBase-3b9fbe0c.js";class m{constructor(t){e(this,"urlPrefix"),this.urlPrefix=t}add(t){return i({url:`${this.urlPrefix}`,method:"post",data:t})}edit(t){return i({url:`${this.urlPrefix}`,method:"put",data:t})}delete(t){return i({url:`${this.urlPrefix}/${t}`,method:"delete"})}details(t){return i({url:`${this.urlPrefix}/${t}`,method:"get",params:{id:t}})}page(t){return i({url:`${this.urlPrefix}/page`,method:"get",params:t})}}class y extends m{constructor(){super("/demo")}async page(t){return{total:2,pages:1,list:[{fieldName:"asds",fieldCode:"sfsd",id:1},{fieldName:"asds2112",fieldCode:"sfsasdd",id:2}]}}}let b=function(t){return t[t.loading=0]="loading",t[t.success=1]="success",t[t.failed=2]="failed",t[t.empty=3]="empty",t}({});const _=s({props:{loadStatus:{type:Number,required:!0},error:{type:String},desc:String},render(){return this.loadStatus==b.success?this.$slots.default(this):this.loadStatus==b.failed||this.error?r(a("el-empty"),{class:"pageError",description:this.error||"获取失败,请稍后重试"},null):this.loadStatus==b.empty?r(a("el-empty"),{description:this.desc||"暂无数据"},null):r(a("el-skeleton"),{row:6,animated:!0,throttle:100},null)}});class C{constructor(t,i){let s,r;e(this,"com"),e(this,"time"),"number"==typeof t?(s=t,r={}):"object"==typeof t?(r=t,s=i||300):(s=i||300,r={}),this.time=setTimeout((()=>{this.com=n.service(r)}),s)}close(){clearTimeout(this.time),this.com&&this.com.close()}}function w(t){return!!t.id}class P{constructor(t,i){e(this,"api"),e(this,"pager"),e(this,"_loadStatus",b.loading),e(this,"_error",null),e(this,"onStatusChange"),e(this,"onError"),this.api=t,this.pager=i}get loadStatus(){return this._loadStatus}get error(){return this._error}confirmAction(t,e,i,s=!0){o.confirm(t,"警告").then((async t=>{const r=new C;try{"function"==typeof e?await e():"string"==typeof e&&(await this.api.delete(e),l.success("删除成功")),s&&this.pager&&this.refresh(),"function"==typeof i&&i()}catch(a){o.alert(`${a}`,{type:"error"})}finally{r.close()}})).catch((()=>{}))}async refresh(t,e){this._loadStatus=b.loading;try{this.pager?(await this.pager.refresh(),1==this.pager.currentPage&&(this._loadStatus=this.pager.items.length?b.success:b.empty)):"function"==typeof t&&(await t(),this._loadStatus=b.success),this.pager&&1==arguments.length&&"function"==typeof t?t():"function"==typeof e&&e()}catch(i){if(this.pager)if(1==this.pager.currentPage){if(this._loadStatus=b.failed,this._error=i,!this.onError||!this.onError(i))throw i}else o.alert(`${i}`,{type:"error"});else if(this._loadStatus=b.failed,this._error=i,!this.onError||!this.onError(i))throw i}finally{this.onStatusChange&&this.onStatusChange(this._loadStatus)}}async addOrEdit(t){var e,i;const s=new C;try{return await(null==(i=(e=this.api)[w(t)?"edit":"add"])?void 0:i.call(e,t)),l.success("操作成功"),this.refresh(),!0}catch(r){o.alert(`${r}`,{type:"error"})}finally{s.close()}}}class S{constructor(t,i,s,r){e(this,"_currentPage",1),e(this,"_loading",!1),e(this,"_pages",1),e(this,"_total",0),e(this,"method"),e(this,"param"),e(this,"wrongBeforePage",1),e(this,"_items",[]),e(this,"infinite"),e(this,"api"),e(this,"_listField"),e(this,"size",10),e(this,"onError"),e(this,"onLastPage"),e(this,"onLoad"),this.api=t,this.method=i.bind(t),this.param=s,this.infinite=r}reset(t){this.param=()=>t}get currentPage(){return this._currentPage}get loading(){return this._loading}get pages(){return this._pages}get noMore(){return this.currentPage>=this.pages}get total(){return this._total}get enablePrev(){return this.currentPage>1}get enableNext(){return this.currentPage<this.pages}get items(){return this._items}get listField(){return this._listField||{}}async prev(){if(this.enablePrev)return this.wrongBeforePage=this._currentPage--,await this._refresh()}async next(){if(this.enableNext)return this.wrongBeforePage=this._currentPage++,await this._refresh()}async goto(t){if(t>=1&&t<=this.pages)return this.wrongBeforePage=this._currentPage,this._currentPage=t,await this._refresh()}async refresh(){return this._refresh(!0)}async _refresh(t=!1){this._loading=!0;try{t&&(this._currentPage=1);let e=()=>{if(this.param){let t=this.param();return t.page=this.currentPage,t.limit=this.size,t}return{page:this.currentPage,limit:this.size}},i=await this.method(e());return this.pages===this.currentPage&&this.onLastPage&&this.onLastPage(this.currentPage),this._total=i.total,this._pages=i.pages,i.listField&&(this._listField=i.listField),this.infinite&&!t?this._items.push(...i.list):this._items=i.list,this.onLoad&&this.onLoad(i.list),i.list}catch(e){if(this._currentPage=this.wrongBeforePage,!this.onError||!this.onError(e))throw e}finally{this._loading=!1}}}const v="_body_6t327_1",x="_tableBox_6t327_5",$="_thead_6t327_5",z=s({props:{pager:{type:Object,required:!0},layout:{type:Array,default:()=>["total","sizes","prev","pager","next"]}},render(){return r(a("el-pagination"),{class:v,currentPage:this.pager.currentPage,"onUpdate:currentPage":t=>this.pager.currentPage=t,"page-size":this.pager.size,"onUpdate:page-size":t=>this.pager.size=t,"page-sizes":[10,15,20,30,50,100],background:!0,layout:this.layout.join(","),total:this.pager.total,onSizeChange:t=>this.onSizeChange(t),onCurrentChange:t=>this.onCurrentChange(t)},null)},methods:{onCurrentChange(t){this.pager.goto(t)},onSizeChange(t){this.pager.size=t,this.pager.refresh()}}}),O=s({props:{tableData:{type:Object,required:!0},columns:{type:Object,required:!0},actionConfig:{type:Object},isAction:{type:Boolean,default:!1},height:{type:[String,Number]},border:{type:Boolean,default:!0}},emits:["selectionChange","sortChange","headerDragend","lock"],render(){const t=()=>{if(this.actionConfig&&this.$slots.actionSlot)return r(a("el-table-column"),{label:this.actionConfig.label||"操作",width:this.actionConfig.width||"180",align:this.actionConfig.align||"center",fixed:"right"},{default:t=>{var e,i;return null==(i=(e=this.$slots).actionSlot)?void 0:i.call(e,t)}})},e=(t,e)=>{var i,s;const n=null==(s=null==(i=this.tableData.listField)?void 0:i.listShowField)?void 0:s.find((e=>e.fieldCode==t.column.property));return r("div",{class:$},[r("span",{style:"margin-right: 5px;"},[e.label]),n&&r(a("el-icon"),{size:"20",color:"#999",title:n.isLock?"解锁":"锁定",onClick:()=>this.$emit("lock",n)},{default:()=>[n.isLock?r(h,null,null):r(d,null,null)]})])};return[r(a("el-table"),{class:x,data:this.list,border:this.border,loading:this.loading,style:{width:"100%",flex:this.height?"unset":1},height:this.height,stripe:!0,"onSort-change":t=>this.$emit("sortChange",t),"onSelection-change":t=>this.$emit("selectionChange",t),"onHeader-dragend":(t,e,i)=>this.$emit("headerDragend",t,i)},{default:()=>[r(a("el-table-column"),{type:"selection",width:"45",align:"center"},null),Object.keys(this.columns).map((t=>{const i=this.columns[t];return r(a("el-table-column"),{prop:t,label:i.label,width:i.width,align:i.align||"center",sortable:i.sortable,formatter:i.formatter,fixed:i.fixed,"show-overflow-tooltip":i.showOverflowTooltip},{header:t=>e(t,i)})})),t()]}),!Array.isArray(this.tableData)&&this.tableData.pages>1&&r(z,{pager:this.tableData},null)]},computed:{list(){return(this.tableData instanceof S?this.tableData.items:this.tableData)||[]},loading(){return this.tableData instanceof S&&this.tableData.loading}},methods:{}}),k="_tableActBox_1soxi_1",E="_action_1soxi_6",j="_searchBox_1rzgo_1",D="_form_1rzgo_32",A="_action_1rzgo_37",B=new class extends p{render(){return r("div",{class:[j,"box"]},[r(a("el-form"),{ref:"form",inline:!0,class:["flex1",D],onKeyup:u((()=>this.$emit("search")),["enter"]),onSubmit:c((()=>{}),["prevent"])},{default:()=>[this.$slots.default&&this.$slots.default(),r(a("el-form-item"),{class:A},{default:()=>[this.$slots.btns&&this.$slots.btns(),r(a("el-button"),{type:"primary",onClick:()=>this.$emit("search")},{default:()=>[g("查询")]}),r(a("el-button"),{type:"default",onClick:()=>this.$emit("reset")},{default:()=>[g("重置")]})]})]})])}},F=new class extends p{constructor(){super(),e(this,"props",{api:{type:Object},method:Object,query:{type:Object},resetQuery:Function,tableConfig:{type:Object,default:()=>({})},dialogConfig:Object,addHandler:Function,editHandler:Function}),e(this,"pager",null),e(this,"handler",null),e(this,"columns",{}),e(this,"buttonSize","default"),e(this,"expose",["refresh","handler"])}async created(){this.pager=new S(this.api,this.method||this.api.page,(()=>this.query)),this.handler=new P(this.api,this.pager),await this.refresh()}render(){return r("div",{class:"app-container"},[this.searchNode(),r("div",{class:"mainBox"},[r("div",{class:k},[r("div",{class:E},[r(a("el-button"),{type:"primary",icon:f,size:this.buttonSize,onClick:()=>this.add()},{default:()=>[g("新增")]}),this.$slots.tableHeadAct&&this.$slots.tableHeadAct()])]),r(_,{loadStatus:this.handler.loadStatus,error:this.handler.error},{default:()=>{var t;return[r(O,{tableData:this.pager,columns:this.columns,actionConfig:(null==(t=this.tableConfig)?void 0:t.actionConfig)||{width:"120"},onSelectionChange:this.selectionChange},{actionSlot:t=>this.actionSlot(t)})]}})])])}searchNode(){var t,e;const i=null==(e=(t=this.$slots).searchItems)?void 0:e.call(t);if(i||Array.isArray(i)&&i.length>0)return r(B,{onSearch:()=>this.refresh(),onReset:()=>this.reset()},{default:()=>i,btns:this.$slots.searchBtns})}actionSlot(t){return[this.$slots.tableAction&&this.$slots.tableAction(t),!this.tableConfig.notEdit&&r(a("el-button"),{type:"primary",link:!0,onClick:()=>this.edit(t.row)},{default:()=>[g("编辑")]}),!this.tableConfig.notDel&&r(a("el-button"),{type:"primary",link:!0,onClick:()=>this.delete(t.row)},{default:()=>[g("删除")]})]}async refresh(){await this.handler.refresh(),this.buildCol()}buildCol(){var t,e;this.columns={},(null==(t=this.tableConfig)?void 0:t.setColumns)?this.tableConfig.setColumns(this.columns,[]):null==(e=this.pager.listField.listShowField)||e.forEach((t=>{var e;this.columns[t.fieldCode]={label:t.fieldName,showOverflowTooltip:!0,width:null==(e=t.width)?void 0:e.toString(),fixed:t.isLock?"left":void 0}}))}add(){this.addHandler?this.addHandler():this.addOrEdit()}edit(t){this.editHandler?this.editHandler(t):this.addOrEdit(t)}addOrEdit(t){if(this.dialogConfig){const e=new this.dialogConfig.editDialog;let i={onConfirm:async t=>this.handler.addOrEdit(t)};this.dialogConfig.editConfig&&(i={...this.dialogConfig.editConfig,onConfirm:this.dialogConfig.editConfig.onConfirm||i.onConfirm}),e.show(t,i)}}delete(t){this.handler.confirmAction("是否删除此数据?",t.id.toString())}reset(){for(const t in this.query)this.query[t]=null;this.resetQuery&&(this.query=this.resetQuery()),this.pager.reset(this.query),this.handler.refresh()}selectionChange(t){this.$emit("selectionChange",t)}};export{F as L,y as T,w as h};
