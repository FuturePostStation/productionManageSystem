var t=Object.defineProperty,e=(e,i,s)=>(((e,i,s)=>{i in e?t(e,i,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[i]=s})(e,"symbol"!=typeof i?i+"":i,s),s);import{at as i,b as s,i as r,f as a,au as n,av as o,E as h,ab as l,q as d,A as c,al as u}from"./index-07a8fef4.js";import{P as g}from"./PageBase-d2127b08.js";class f{constructor(t){e(this,"urlPrefix"),this.urlPrefix=t}add(t){return i({url:`${this.urlPrefix}`,method:"post",data:t})}edit(t){return i({url:`${this.urlPrefix}`,method:"put",data:t})}delete(t){return i({url:`${this.urlPrefix}/${t}`,method:"delete"})}details(t){return i({url:`${this.urlPrefix}/${t}`,method:"get",params:{id:t}})}page(t){return i({url:`${this.urlPrefix}/page`,method:"get",params:t})}}class p extends f{constructor(){super("/demo")}async page(){return{total:2,pages:1,list:[{fieldName:"asds",fieldCode:"sfsd",id:1},{fieldName:"asds2112",fieldCode:"sfsasdd",id:2}]}}}let m=function(t){return t[t.loading=0]="loading",t[t.success=1]="success",t[t.failed=2]="failed",t[t.empty=3]="empty",t}({});const y=s({props:{loadStatus:{type:Number,required:!0},error:{type:String},desc:String},render(){return this.loadStatus==m.success?this.$slots.default(this):this.loadStatus==m.failed||this.error?r(a("el-empty"),{class:"pageError",description:this.error||"获取失败,请稍后重试"},null):this.loadStatus==m.empty?r(a("el-empty"),{description:this.desc||"暂无数据"},null):r(a("el-skeleton"),{row:6,animated:!0,throttle:100},null)}});class b{constructor(t,i){let s,r;e(this,"com"),e(this,"time"),"number"==typeof t?(s=t,r={}):"object"==typeof t?(r=t,s=i||300):(s=i||300,r={}),this.time=setTimeout((()=>{this.com=n.service(r)}),s)}close(){clearTimeout(this.time),this.com&&this.com.close()}}function _(t){return!!t.id}class C{constructor(t,i){e(this,"api"),e(this,"pager"),e(this,"_loadStatus",m.loading),e(this,"_error",null),e(this,"onStatusChange"),e(this,"onError"),this.api=t,this.pager=i}get loadStatus(){return this._loadStatus}get error(){return this._error}confirmAction(t,e,i,s=!0){o.confirm(t,"警告").then((async()=>{const t=new b;try{"function"==typeof e?await e():"string"==typeof e&&(await this.api.delete(e),h.success("删除成功")),s&&this.pager&&this.refresh(),"function"==typeof i&&i()}catch(r){o.alert(`${r}`,{type:"error"})}finally{t.close()}})).catch((()=>{}))}async refresh(t,e){this._loadStatus=m.loading;try{this.pager?(await this.pager.refresh(),"function"==typeof t&&await t(),1==this.pager.currentPage&&(this._loadStatus=this.pager.items.length?m.success:m.empty)):"function"==typeof t&&(await t(),this._loadStatus=m.success),"function"==typeof e&&e()}catch(i){if(this.pager)if(1==this.pager.currentPage){if(this._loadStatus=m.failed,this._error=i,!this.onError||!this.onError(i))throw i}else o.alert(`${i}`,{type:"error"});else if(this._loadStatus=m.failed,this._error=i,!this.onError||!this.onError(i))throw i}finally{this.onStatusChange&&this.onStatusChange(this._loadStatus)}}async addOrEdit(t){var e,i;const s=new b;try{return await(null==(i=(e=this.api)[_(t)?"edit":"add"])?void 0:i.call(e,t)),h.success("操作成功"),this.refresh(),!0}catch(r){o.alert(`${r}`,{type:"error"})}finally{s.close()}}}class w{constructor(t,i,s,r){e(this,"_currentPage",1),e(this,"_loading",!1),e(this,"_pages",1),e(this,"_total",0),e(this,"method"),e(this,"param"),e(this,"wrongBeforePage",1),e(this,"_items",[]),e(this,"infinite"),e(this,"api"),e(this,"size",10),e(this,"onError"),e(this,"onLastPage"),e(this,"onLoad"),this.api=t,this.method=i.bind(t),this.param=s,this.infinite=r}reset(t){this.param=()=>t}get currentPage(){return this._currentPage}get loading(){return this._loading}get pages(){return this._pages}get noMore(){return this.currentPage>=this.pages}get total(){return this._total}get enablePrev(){return this.currentPage>1}get enableNext(){return this.currentPage<this.pages}get items(){return this._items}async prev(){if(this.enablePrev)return this.wrongBeforePage=this._currentPage--,await this._refresh()}async next(){if(this.enableNext)return this.wrongBeforePage=this._currentPage++,await this._refresh()}async goto(t){if(t>=1&&t<=this.pages)return this.wrongBeforePage=this._currentPage,this._currentPage=t,await this._refresh()}async refresh(){return this._refresh(!0)}async _refresh(t=!1){this._loading=!0;try{t&&(this._currentPage=1);const e=()=>{if(this.param){const t=this.param();return t.page=this.currentPage,t.limit=this.size,t}return{page:this.currentPage,limit:this.size}},i=await this.method(e());return this.pages===this.currentPage&&this.onLastPage&&this.onLastPage(this.currentPage),this._total=i.total,this._pages=i.pages,this.infinite&&!t?this._items.push(...i.list):this._items=i.list,this.onLoad&&this.onLoad(i.list),i.list}catch(e){if(this._currentPage=this.wrongBeforePage,!this.onError||!this.onError(e))throw e}finally{this._loading=!1}}}const P="_body_6t327_1",S="_tableBox_6t327_5",$=s({props:{pager:{type:Object,required:!0},layout:{type:Array,default:()=>["total","sizes","prev","pager","next"]}},render(){return r(a("el-pagination"),{class:P,currentPage:this.pager.currentPage,"onUpdate:currentPage":t=>this.pager.currentPage=t,"page-size":this.pager.size,"onUpdate:page-size":t=>this.pager.size=t,"page-sizes":[10,15,20,30,50,100],background:!0,layout:this.layout.join(","),total:this.pager.total,onSizeChange:t=>this.onSizeChange(t),onCurrentChange:t=>this.onCurrentChange(t)},null)},methods:{onCurrentChange(t){this.pager.goto(t)},onSizeChange(t){this.pager.size=t,this.pager.refresh()}}}),x=s({props:{tableData:{type:Object,required:!0},columns:{type:Object,required:!0},actionConfig:{type:Object},isAction:{type:Boolean,default:!1},height:{type:[String,Number]},border:{type:Boolean,default:!0},rowKey:String},emits:["selectionChange","sortChange","headerDragend","lock"],render(){const t=()=>{if(this.actionConfig&&this.$slots.actionSlot)return r(a("el-table-column"),{label:this.actionConfig.label||"操作",width:this.actionConfig.width||"180",align:this.actionConfig.align||"center",fixed:"right"},{default:t=>{var e,i;return null==(i=(e=this.$slots).actionSlot)?void 0:i.call(e,t)}})};return[r(a("el-table"),{class:this.rowKey?void 0:S,data:this.list,border:this.border,loading:this.loading,style:{width:"100%",flex:this.height?"unset":1},height:this.height,stripe:!0,"row-key":this.rowKey,"onSort-change":t=>this.$emit("sortChange",t),"onSelection-change":t=>this.$emit("selectionChange",t),"onHeader-dragend":(t,e,i)=>this.$emit("headerDragend",t,i)},{default:()=>[r(a("el-table-column"),{type:"selection",width:"45",align:"center"},null),Object.keys(this.columns).map((t=>{const e=this.columns[t];return r(a("el-table-column"),{prop:t,label:e.label,width:e.width,align:e.align||"center",sortable:e.sortable,formatter:e.formatter,fixed:e.fixed,"show-overflow-tooltip":e.showOverflowTooltip},null)})),t()]}),!Array.isArray(this.tableData)&&this.tableData.pages>1&&r($,{pager:this.tableData},null)]},computed:{list(){return(this.tableData instanceof w?this.tableData.items:this.tableData)||[]},loading(){return this.tableData instanceof w&&this.tableData.loading}},methods:{}}),v="_tableActBox_1soxi_1",z="_action_1soxi_6",O="_searchBox_1rzgo_1",A="_form_1rzgo_32",E="_action_1rzgo_37",j=new class extends g{constructor(){super(...arguments),e(this,"emits",["reset","search"])}render(){return r("div",{class:[O,"box"]},[r(a("el-form"),{ref:"form",inline:!0,class:["flex1",A],onKeyup:l((()=>this.$emit("search")),["enter"]),onSubmit:d((()=>{}),["prevent"])},{default:()=>[this.$slots.default&&this.$slots.default(),r(a("el-form-item"),{class:E},{default:()=>[this.$slots.btns&&this.$slots.btns(),r(a("el-button"),{type:"primary",onClick:()=>this.$emit("search")},{default:()=>[c("查询")]}),r(a("el-button"),{type:"default",onClick:()=>this.$emit("reset")},{default:()=>[c("重置")]})]})]})])}},B=new class extends g{constructor(){super(),e(this,"props",{api:{type:Object},method:Object,query:{type:Object},resetQuery:Function,tableConfig:{type:Object,default:()=>({})},dialogConfig:Object,addHandler:Function,editHandler:Function,notAdd:Boolean}),e(this,"expose",["refresh","handler"]),e(this,"emits",["selectionChange"]),e(this,"pager",null),e(this,"handler",null),e(this,"columns",{}),e(this,"buttonSize","default")}async created(){this.pager=new w(this.api,this.method||this.api.page,(()=>this.query)),this.handler=new C(this.api,this.pager),await this.refresh()}render(){return r("div",{class:"app-container"},[this.searchNode(),r("div",{class:"mainBox"},[r("div",{class:v},[r("div",{class:z},[!this.notAdd&&r(a("el-button"),{type:"primary",icon:u,size:this.buttonSize,onClick:()=>this.add()},{default:()=>[c("新增")]}),this.$slots.tableHeadAct&&this.$slots.tableHeadAct()])]),r(y,{loadStatus:this.handler.loadStatus,error:this.handler.error},{default:()=>{var t;return[r(x,{tableData:this.pager,columns:this.columns,actionConfig:(null==(t=this.tableConfig)?void 0:t.actionConfig)||{width:"120"},onSelectionChange:this.selectionChange},{actionSlot:t=>this.actionSlot(t)})]}})])])}searchNode(){var t,e;const i=null==(e=(t=this.$slots).searchItems)?void 0:e.call(t);if(i||Array.isArray(i)&&i.length>0)return r(j,{onSearch:()=>this.refresh(),onReset:()=>this.reset()},{default:()=>i,btns:this.$slots.searchBtns})}actionSlot(t){return[this.$slots.tableAction&&this.$slots.tableAction(t),!this.tableConfig.notEdit&&r(a("el-button"),{type:"primary",link:!0,onClick:()=>this.edit(t.row)},{default:()=>[c("编辑")]}),!this.tableConfig.notDel&&r(a("el-button"),{type:"primary",link:!0,onClick:()=>this.delete(t.row)},{default:()=>[c("删除")]})]}async refresh(){await this.handler.refresh(),this.buildCol()}buildCol(){var t;this.columns={},(null==(t=this.tableConfig)?void 0:t.setColumns)?this.tableConfig.setColumns(this.columns):this.$alert("请配置表头")}add(){this.addHandler?this.addHandler():this.addOrEdit()}edit(t){this.editHandler?this.editHandler(t):this.addOrEdit(t)}addOrEdit(t){if(this.dialogConfig){const e=new this.dialogConfig.editDialog;let i={onConfirm:async t=>this.handler.addOrEdit(t)};this.dialogConfig.editConfig&&(i={...this.dialogConfig.editConfig,onConfirm:this.dialogConfig.editConfig.onConfirm||i.onConfirm}),e.show(t,i)}}delete(t){this.handler.confirmAction("是否删除此数据?",t.id.toString())}reset(){for(const t in this.query)this.query[t]=null;this.resetQuery&&(this.query=this.resetQuery()),this.pager.reset(this.query),this.handler.refresh()}selectionChange(t){this.$emit("selectionChange",t)}};export{B as L,p as T,_ as h};
