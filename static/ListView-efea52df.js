var t=Object.defineProperty,e=(e,s,i)=>(((e,s,i)=>{s in e?t(e,s,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[s]=i})(e,"symbol"!=typeof s?s+"":s,i),i);import{an as s,b as i,i as r,f as a,av as o,aw as n,E as l,ac as h,q as d,A as c,am as u}from"./index-9342aa3d.js";import{h as f,P as p,M as g}from"./MyTable-caa8171d.js";import{P as m}from"./PageBase-d6cb1b12.js";class y{constructor(t){e(this,"urlPrefix"),this.urlPrefix=t}add(t){return s({url:`${this.urlPrefix}`,method:"post",data:t})}edit(t){return s({url:`${this.urlPrefix}`,method:"put",data:t})}delete(t){return s({url:`${this.urlPrefix}/${t}`,method:"delete"})}details(t){return s({url:`${this.urlPrefix}Info/${t}`,method:"get",params:{id:t}})}page(t){return s({url:`${this.urlPrefix}/page`,method:"post",data:t})}}let b=function(t){return t[t.loading=0]="loading",t[t.success=1]="success",t[t.failed=2]="failed",t[t.empty=3]="empty",t}({});const C=i({props:{loadStatus:{type:Number,required:!0},error:{type:String},desc:String},render(){return this.loadStatus==b.success?this.$slots.default(this):this.loadStatus==b.failed||this.error?r(a("el-empty"),{class:"pageError",description:this.error||"获取失败,请稍后重试"},null):this.loadStatus==b.empty?r(a("el-empty"),{description:this.desc||"暂无数据"},null):r(a("el-skeleton"),{row:6,animated:!0,throttle:100},null)}});class S{constructor(t,s){let i,r;e(this,"com"),e(this,"time"),"number"==typeof t?(i=t,r={}):"object"==typeof t?(r=t,i=s||300):(i=s||300,r={}),this.time=setTimeout((()=>{this.com=o.service(r)}),i)}close(){clearTimeout(this.time),this.com&&this.com.close()}}class _{constructor(t,s){e(this,"api"),e(this,"pager"),e(this,"_loadStatus",b.loading),e(this,"_error",null),e(this,"onStatusChange"),e(this,"onError"),this.api=t,this.pager=s}get loadStatus(){return this._loadStatus}get error(){return this._error}confirmAction(t,e,s,i=!0){n.confirm(t,"警告").then((async()=>{const t=new S;try{"function"==typeof e?await e():"string"==typeof e&&(await this.api.delete(e),l.success("删除成功")),i&&this.pager&&this.refresh(),"function"==typeof s&&s()}catch(r){n.alert(`${r}`,{type:"error"})}finally{t.close()}})).catch((()=>{}))}async refresh(t,e){this._loadStatus=b.loading;try{this.pager?(await this.pager.refresh(),"function"==typeof t&&await t(),1==this.pager.currentPage&&(this._loadStatus=this.pager.items.length?b.success:b.empty)):"function"==typeof t&&(await t(),this._loadStatus=b.success),"function"==typeof e&&e()}catch(s){if(this.pager)if(1==this.pager.currentPage){if(this._loadStatus=b.failed,this._error=s,!this.onError||!this.onError(s))throw s}else n.alert(`${s}`,{type:"error"});else if(this._loadStatus=b.failed,this._error=s,!this.onError||!this.onError(s))throw s}finally{this.onStatusChange&&this.onStatusChange(this._loadStatus)}}async addOrEdit(t){var e,s;const i=new S;try{return await(null==(s=(e=this.api)[f(t)?"edit":"add"])?void 0:s.call(e,t)),l.success("操作成功"),this.refresh(),!0}catch(r){n.alert(`${r}`,{type:"error"})}finally{i.close()}}}const $="_tableActBox_1soxi_1",w="_action_1soxi_6",x="_searchBox_1rzgo_1",v="_form_1rzgo_32",E="_action_1rzgo_37",P=new class extends m{constructor(){super(...arguments),e(this,"emits",["reset","search"])}render(){return r("div",{class:[x,"box"]},[r(a("el-form"),{ref:"form",inline:!0,class:["flex1",v],onKeyup:h((()=>this.$emit("search")),["enter"]),onSubmit:d((()=>{}),["prevent"])},{default:()=>[this.$slots.default&&this.$slots.default(),r(a("el-form-item"),{class:E},{default:()=>[this.$slots.btns&&this.$slots.btns(),r(a("el-button"),{type:"primary",onClick:()=>this.$emit("search")},{default:()=>[c("查询")]}),r(a("el-button"),{type:"default",onClick:()=>this.$emit("reset")},{default:()=>[c("重置")]})]})]})])}},A=new class extends m{constructor(){super(),e(this,"props",{api:{type:Object},method:Object,query:{type:Object},resetQuery:Function,tableConfig:{type:Object,default:()=>({})},dialogConfig:Object,addHandler:Function,editHandler:Function,notAdd:Boolean}),e(this,"expose",["refresh","handler"]),e(this,"emits",["selectionChange"]),e(this,"pager",null),e(this,"handler",null),e(this,"columns",{}),e(this,"buttonSize","default")}async created(){this.pager=new p(this.api,this.method||this.api.page,(()=>this.query)),this.handler=new _(this.api,this.pager),await this.refresh()}render(){return r("div",{class:"app-container"},[this.searchNode(),r("div",{class:"mainBox"},[r("div",{class:$},[r("div",{class:w},[!this.notAdd&&r(a("el-button"),{type:"primary",icon:u,size:this.buttonSize,onClick:()=>this.add()},{default:()=>[c("新增")]}),this.$slots.tableHeadAct&&this.$slots.tableHeadAct()])]),r(C,{loadStatus:this.handler.loadStatus,error:this.handler.error},{default:()=>{var t;return[r(g,{tableData:this.pager,columns:this.columns,actionConfig:(null==(t=this.tableConfig)?void 0:t.actionConfig)||{width:"120"},onSelectionChange:this.selectionChange},{actionSlot:this.actionSlot})]}})])])}searchNode(){var t,e;const s=null==(e=(t=this.$slots).searchItems)?void 0:e.call(t);if(s||Array.isArray(s)&&s.length>0)return r(P,{onSearch:()=>this.refresh(),onReset:()=>this.reset()},{default:()=>s,btns:this.$slots.searchBtns})}actionSlot(t){return[this.$slots.tableAction&&this.$slots.tableAction(t),!this.tableConfig.notEdit&&r(a("el-button"),{type:"primary",link:!0,onClick:()=>this.edit(t.row)},{default:()=>[c("编辑")]}),!this.tableConfig.notDel&&r(a("el-button"),{type:"primary",link:!0,onClick:()=>this.delete(t.row)},{default:()=>[c("删除")]})]}async refresh(){await this.handler.refresh(),this.buildCol()}buildCol(){var t;this.columns={},(null==(t=this.tableConfig)?void 0:t.setColumns)?this.tableConfig.setColumns(this.columns):this.$alert("请配置表头")}add(){this.addHandler?this.addHandler():this.addOrEdit()}edit(t){this.editHandler?this.editHandler(t):this.addOrEdit(t)}addOrEdit(t){if(this.dialogConfig){const e=new this.dialogConfig.editDialog;let s={onConfirm:async t=>this.handler.addOrEdit(t)};this.dialogConfig.editConfig&&(s={...this.dialogConfig.editConfig,onConfirm:this.dialogConfig.editConfig.onConfirm||s.onConfirm}),e.show(t,s)}}delete(t){this.handler.confirmAction("是否删除此数据?",t.id.toString())}reset(){for(const t in this.query)this.query[t]=null;this.resetQuery&&(this.query=this.resetQuery()),this.pager.reset(this.query),this.handler.refresh()}selectionChange(t){this.$emit("selectionChange",t)}};export{y as C,A as L};
