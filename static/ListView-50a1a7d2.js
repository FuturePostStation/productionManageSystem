var t=Object.defineProperty,e=(e,s,i)=>(((e,s,i)=>{s in e?t(e,s,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[s]=i})(e,"symbol"!=typeof s?s+"":s,i),i);import{b as s,i,f as r,av as a,E as o,ac as n,q as l,A as h,am as d}from"./index-4a918107.js";import{M as c}from"./Loading-80bc43c3.js";import{h as u}from"./tools-8b80f190.js";import{P as f,M as p}from"./MyTable-7d66d367.js";import{P as g}from"./PageBase-d1889d10.js";let y=function(t){return t[t.loading=0]="loading",t[t.success=1]="success",t[t.failed=2]="failed",t[t.empty=3]="empty",t}({});const m=s({props:{loadStatus:{type:Number,required:!0},error:{type:String},desc:String},render(){return this.loadStatus==y.success?this.$slots.default(this):this.loadStatus==y.failed||this.error?i(r("el-empty"),{class:"pageError",description:this.error||"获取失败,请稍后重试"},null):this.loadStatus==y.empty?i(r("el-empty"),{description:this.desc||"暂无数据"},null):i(r("el-skeleton"),{row:6,animated:!0,throttle:100},null)}});class b{constructor(t,s){e(this,"api"),e(this,"pager"),e(this,"_loadStatus",y.loading),e(this,"_error",null),e(this,"onStatusChange"),e(this,"onError"),this.api=t,this.pager=s}get loadStatus(){return this._loadStatus}get error(){return this._error}confirmAction(t,e,s,i=!0){a.confirm(t,"警告").then((async()=>{const t=new c;try{"function"==typeof e?await e():"string"==typeof e&&(await this.api.delete(e),o.success("删除成功")),i&&this.pager&&this.refresh(),"function"==typeof s&&s()}catch(r){a.alert(`${r}`,{type:"error"})}finally{t.close()}})).catch((()=>{}))}async refresh(t,e){this._loadStatus=y.loading;try{this.pager?(await this.pager.refresh(),"function"==typeof t&&await t(),1==this.pager.currentPage&&(this._loadStatus=this.pager.items.length?y.success:y.empty)):"function"==typeof t&&(await t(),this._loadStatus=y.success),"function"==typeof e&&e()}catch(s){if(this.pager)if(1==this.pager.currentPage){if(this._loadStatus=y.failed,this._error=s,!this.onError||!this.onError(s))throw s}else a.alert(`${s}`,{type:"error"});else if(this._loadStatus=y.failed,this._error=s,!this.onError||!this.onError(s))throw s}finally{this.onStatusChange&&this.onStatusChange(this._loadStatus)}}async addOrEdit(t){var e,s;const i=new c;try{return await(null==(s=(e=this.api)[u(t)?"edit":"add"])?void 0:s.call(e,t)),o.success("操作成功"),this.refresh(),!0}catch(r){a.alert(`${r}`,{type:"error"})}finally{i.close()}}}const C="_tableActBox_1soxi_1",S="_action_1soxi_6",_="_searchBox_1rzgo_1",w="_form_1rzgo_32",$="_action_1rzgo_37",v=new class extends g{constructor(){super(...arguments),e(this,"emits",["reset","search"])}render(){return i("div",{class:[_,"box"]},[i(r("el-form"),{ref:"form",inline:!0,class:["flex1",w],onKeyup:n((()=>this.$emit("search")),["enter"]),onSubmit:l((()=>{}),["prevent"])},{default:()=>[this.$slots.default&&this.$slots.default(),i(r("el-form-item"),{class:$},{default:()=>[this.$slots.btns&&this.$slots.btns(),i(r("el-button"),{type:"primary",onClick:()=>this.$emit("search")},{default:()=>[h("查询")]}),i(r("el-button"),{type:"default",onClick:()=>this.$emit("reset")},{default:()=>[h("重置")]})]})]})])}},E=new class extends g{constructor(){super(),e(this,"props",{api:{type:Object},method:Object,query:{type:Object},resetQuery:Function,tableConfig:{type:Object,default:()=>({})},dialogConfig:Object,addHandler:Function,editHandler:Function,notAdd:Boolean,idKey:{type:String,default:"id"}}),e(this,"expose",["refresh","handler"]),e(this,"emits",["selectionChange"]),e(this,"pager",null),e(this,"handler",null),e(this,"columns",{}),e(this,"buttonSize","default")}async created(){this.pager=new f(this.api,this.method||this.api.page,(()=>this.query)),this.pager.onError=t=>!0,this.handler=new b(this.api,this.pager),await this.refresh()}render(){return i("div",{class:"app-container"},[this.searchNode(),i("div",{class:"mainBox"},[i("div",{class:C},[i("div",{class:S},[!this.notAdd&&i(r("el-button"),{type:"primary",icon:d,size:this.buttonSize,onClick:()=>this.add()},{default:()=>[h("新增")]}),this.$slots.tableHeadAct&&this.$slots.tableHeadAct()])]),i(m,{loadStatus:this.handler.loadStatus,error:this.handler.error},{default:()=>{var t;return[i(p,{tableData:this.pager,columns:this.columns,actionConfig:(null==(t=this.tableConfig)?void 0:t.actionConfig)||{width:"120"},onSelectionChange:this.selectionChange},{actionSlot:this.actionSlot})]}})])])}searchNode(){var t,e;const s=null==(e=(t=this.$slots).searchItems)?void 0:e.call(t);if(s||Array.isArray(s)&&s.length>0)return i(v,{onSearch:()=>this.refresh(),onReset:()=>this.reset()},{default:()=>s,btns:this.$slots.searchBtns})}actionSlot(t){return[this.$slots.tableAction&&this.$slots.tableAction(t),!this.tableConfig.notEdit&&i(r("el-button"),{type:"primary",link:!0,onClick:()=>this.edit(t.row)},{default:()=>[h("编辑")]}),!this.tableConfig.notDel&&i(r("el-button"),{type:"primary",link:!0,onClick:()=>this.delete(t.row)},{default:()=>[h("删除")]})]}async refresh(){await this.handler.refresh(),this.buildCol()}buildCol(){var t;this.columns={},(null==(t=this.tableConfig)?void 0:t.setColumns)?this.tableConfig.setColumns(this.columns):this.$alert("请配置表头")}add(){this.addHandler?this.addHandler():this.addOrEdit()}edit(t){this.editHandler?this.editHandler(t):this.addOrEdit(t)}addOrEdit(t){if(this.dialogConfig){const e=new this.dialogConfig.editDialog;let s={onConfirm:async t=>this.handler.addOrEdit(t)};this.dialogConfig.editConfig&&(s={...this.dialogConfig.editConfig,onConfirm:this.dialogConfig.editConfig.onConfirm||s.onConfirm}),e.show(t,s)}}delete(t){this.handler.confirmAction("是否删除此数据?",t[this.idKey].toString())}reset(){for(const t in this.query)this.query[t]=null;this.resetQuery&&(this.query=this.resetQuery()),this.pager.reset(this.query),this.handler.refresh()}selectionChange(t){this.$emit("selectionChange",t)}};export{E as L};
